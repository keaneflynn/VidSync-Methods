---
title: 'Videogrammetry Metrics for Assessing Fish Foraging Behavior: Implications
  for Behavioral Ecology and Management'
author: "Keane Flynn"
date: "4/30/2019"
output:
  word_document: default
  html_document: default
---
#**Introduction**

          Fish foraging behavior has long been a topic of natural observation,  wonder, and recreational curiosity (Walton 1655). For decades, fisheries scientists have also observed foraging behavior and considered the implications of forging behavior on fish growth and energetics (Fuasch 1984; Hughes and Dill 1990; Hayes et al. 2000), adaptation to habitat variability and contexts (Dill 1983; Fausch et al. 1997; Nislow et al. 1998; Nielson 1992), niche partitioning between sympatric species (Nakano et al. 1999a) and ontogeny (Sánchez-Hernández et al. 2012). A major challenge in the scientific study of foraging behavior has been limitations associated with visual observation, including: (1) poor estimation of quantities such as  distance, length, and time, (2) the inability to follow multiple focal animals at one time, (3) the inability to review a behavioral sequence or to share with multiple observers, (4) the inability to deal with quick or fleeting  behaviors in real time, and (5) making observations in a non-invasive method to retain natural behavior (Altmann 1974, Neuswanger 2016). Recent advances in videogrammetry and computer programming technologies have provided technological solutions for some of these problems and made it possible to collect precise quantitative and qualitative measurements of animal behavior and interactions in 3-dimensional space (Neuswanger 2016, Hughes and Kelly 1996; Vivancos and Closs 2015, Piccolo et al. 2007).
          The videogrammetric program Vidsync represents one of the first open source software programs to provide quantitative 3-D functionality to fish behavior ecology (Neuswanger 2016). Vidsync is a novel software program that allows the user to triangulate a 3D position, in relative space, from two or more known lines of sight (Neuswanger 2016a). The software was developed for in situ study of juvenile chinook drift-feeding behavior and growth rates (Neuswanger et al. 2014). Data collection is accomplished by calibration of two or more simultaneous in-stream videos via a dual-plane calibration frame with known, uniform distances between each point across the X, Y, Z axis (Figure 1). The primary output data from the Vidsync analysis was X, Y, Z location, time, an object (subsample and fish identification number), event (foraging or interactive behavior), or measurement (e.g. length and z-axis location of the surface) (Figure 2). These coordinates, timecodes, and observations can then be exported and processed into code-based programs to create statistical and graphical representations of the data collected.
    
![**Figure 1** Calibration frame used in the VidSync program to calibrate the two videos to calculate positions in relative space](VidSyncFrame.png)

![**Figure 2** Profile view of a pool-riffle sequence with X, Y, Z planes relative to a fish maintaining positive rheotaxis.](XYZPlanes.png)

          Although videogrammetric programs such as Vidsync have allowed for profound improvements in the functional ability to track and quantify animal behavior, locations and movement, there has yet to be an effort to synthesize classical ethology and foraging ecology methods with output from the 3-D videogrammetric tools. In addition, the possibility of using behavioral states or changes in threshold behaviors as indicators of environmental change for resource managers is enhanced by the quantitively power of 3-D videogrammetrics (Sih et al. 2011). However, this application of videogrammetry has not been explored. In this paper we will introduce a set of specific methods to quantify behavioral states and behavioral gradients in juvenile salmonids using the 3-D program Vidsync focusing on behaviors with a long history of use in foraging ecology. We will also link the quantitative methods for evaluating these behaviors to potential management applications such as instream flow science or habitat restoration monitoring specifically targeting juvenile salmonids. Our objective is to provide a methodological and contextual basis for synthesize classical methods in juvenile foraging ecology with novel videogrammetric tools, and to consider the application of these methods to some targeted management scenarios.

#**Methods**
##**Overview**

![**Figure 3** Flow chart of VidSync use from field to analysis](VidSync Flow Chart.png)

##**Data Collection**
###*Streamside set up and use*

          LaGrangian vs Eularian
          
          For underwater videography, we found that using GoPro cameras allowed for a relatively low-cost method of video capture as well as wide angle lens to capture all fish in the study area continuously. To properly mount these cameras for multiple samples at the same site, we found that having multiple mount points to the streambed via rebar hammered into the alluvium ensures that the same habitat area is recorded each time. To fix the cameras to the mount, a simple device made from PVC pipe and bicycle mounts covers the widest amount of habitat while minimizing area where the camera angles do not overlap (Figure 2). 
    
![**Figure 4** Fusion 360 schematic for how to mount GoPro cameras for VidSync applications](GoProMountSchematic.png)
    
          When recording behavior, especially in low-flow situations, it is important to enter the river to mount the camera from downstream to avoid increasing turbidity in the study area. That being said, this method should not be employed in areas of high turbidity as behavior observations will be abysmal. While it depends on the specific study, we recommend roughly 25-30 minutes of recording to ensure usable behavioral observations are recorded. Immediately following the recording period, someone must enter the creek with a calibration frame (from downstream to avoid increasing turbidity) and place it in front of the cameras where all points on the frame are visible (Figure 3). 

###*Test Measurements*

          Once the videos have been recorded, loaded into VidSync, and calibrated, this calibrated video must be tested to ensure that the measurements are valid (Neuswanger 2014; Neuswanger 2016b). Using the known distances between points on the calibration frame, test measurements can be made along the X (front frame to rear frame), Y, and Z axes using the length function in the program to ensure that what you are measuring in VidSync matches empirical measurement data (Figure 1).
##**Data Analysis**
          
          VidSync tutorials and use have been well established for creating data from video observations (Neuswanger 2014; Neuswanger 2016b). However, its use for specific metric that might have ecological implications have not been well documented. In this section, we will look in-depth at 6 methods of data analysis, including: proportion of forage behaviors, fork length calculations (FL), distance per time, nearest neightbor distance (NND), distance from surface, and occupied volume. For each of these analyses, we will look at the (1) use of each calculation in behavioral ecology, (2) the significance of each calculation, (3) how these measurements are made for this application, and (4) exemplary R code for each of these calculations.

          For data analyzation, we will be using R-Studio to compute the following metrics (RStudio Team 2015). They can be imported into other softwares such as MATLAB and Wolfram Mathematica, however for the level of analyzation being performed below, we have found that using R-Studio is the most simple method with the most amount of support.

```{r setup, include = FALSE, message = FALSE}
library(dplyr)
library(readr)
library(tidyverse)
library(ggplot2)
library(geometry)
library(rgl)
library(zoo)
library(stringr)
```
###*Importing VidSync CSV File*

          Data from VidSync can either be exported as an XML or CSV file, for our application we will be exporting it as the latter into R for analyzation. Upon importing it, we will be cleaning up some of the data vectors using regular expression matching for ease of operation through the Stringr package in R (Whickam 2018). 
```{r warning=FALSE}
VidSync_Test_Data <- readr::read_csv(file = "VidSync-TestData.csv", 
                             skip = 2,
                             col_names = c("objects", "event", "timecode", "time_sec", "X", "Y", "Z", "pld_error", "projection_error", "nearest_camera_distance", "screen_coordinates"),
                    col_types = "cccdddddddd") %>% 
  mutate(subsample = as.numeric(str_extract(objects, "\\d"))) %>% #This column will identify which of the 6 subsamples the data belongs to.
  mutate(fish_ID = as.numeric(str_extract(objects, "\\h\\d{1,2}"))) %>% #A fish ID denotes a unique individual during each subsample. Unique individuals can be tracked across subsamples if desired, but must be given a unique name in the "Name" option (i.e. Omykiss-A1) when the Event type is specified while being processed in VidSync.
  mutate(species = str_extract(objects, "Omykiss|Okisutch")) %>% #Note that the use of regular expressions in this line are to be specified to whatever species are being recorded in your experiment and excluding any non-relevant ones.
  select(subsample, fish_ID, species, time_sec, X, Y, Z, objects, event) #All other data vectors were excluded for the sake of neatness and what is useful in the metrics below.
```
##Nearest Neighbor Distance

          Nearest neighbor distance (NND) has historically been used as a metric for understanding inter/intraspecies interactions as well as making observations about general trends regarding animal density in a study region (Clark 1954). NND is calculated by finding the nearest neighbor to each unique fish over the course of a subsample. The final NND column will return a single NND value for each fish in a subsample and represent the closest nearest neighbor for each fish and exclude any larger distances (in cm) so as to not skew the data away from any values that are the absolute nearest neighbor point over the course of the subsample. It is important to note that subsamples with only one observed fish will produce an NND that is infinite and should be dealt with accordingly when graphing/calculating statistics of these values.
    
    The exemplary data is as follows:
```{r}
NND_Data <- VidSync_Test_Data %>% 
  filter(grepl("^Subsample.*", objects)) %>% #In the following two lines of code, we will be removing any extraneous data points that are not relevant to the regular 3 second interval sample points taken.
  filter(!grepl("^Length.*", event)) %>%
  na.omit() %>% #To remove any additional rows from the data set not associated with fish (i.e. surface shots).
  arrange(time_sec) %>%
  group_by(time_sec) %>%
  mutate(distance_between_X = X - lag(X, default = first(X))) %>%
  mutate(distance_between_Y = Y - lag(Y, default = first(Y))) %>%
  mutate(distance_between_Z = Z - lag(Z, default = first(Z))) %>%
  mutate(nnd_cm = sqrt((distance_between_X)^2 + 
                      (distance_between_Y)^2 +
                      (distance_between_Z)^2)) %>%
  group_by(time_sec) %>%
  filter(!nnd_cm == 0) %>%
  filter(nnd_cm == min(nnd_cm)) %>%
  ungroup() %>% 
  distinct(fish_ID, .keep_all = TRUE) %>% 
  arrange(subsample, fish_ID, time_sec) %>%
  select(subsample, fish_ID, nnd_cm) 
```
##Distance per Time

    Calculating distance per time is calculated by tracking a specific individual over the course of a subsample and dividing the distance travelled between each sample point by the time between each point. The distance between each point is calculated using the three dimensional distance formula: sqrt((X1-X2)^2+(Y1-Y2)^2+(Z1-Z2)^2).
    
    The exemplary data is as follows:
```{r}
DistancePerTime_Data <- VidSync_Test_Data %>% 
  filter(!grepl("Surface_Shots.*", objects)) %>%
  filter(!grepl("^Length.*", event)) %>%
  group_by(fish_ID) %>% 
  mutate(distance_travelled_X_cm = X - lag(X, default = first(X))) %>%
  mutate(distance_travelled_Y_cm = Y - lag(Y, default = first(Y))) %>%
  mutate(distance_travelled_Z_cm = Z - lag(Z, default = first(Z))) %>%
  mutate(fish_distance_travelled_cm = sqrt((distance_travelled_X_cm)^2
                                        + (distance_travelled_Y_cm)^2
                                        + (distance_travelled_Z_cm)^2)) %>%
  ungroup() %>% 
  group_by(fish_ID) %>%
  mutate(distance_cm_per_sec = fish_distance_travelled_cm /(time_sec - lag(time_sec, default = first(time_sec)))) %>%
  filter(!distance_cm_per_sec == Inf) %>% 
  arrange(subsample, fish_ID, time_sec) %>%
  select(subsample, fish_ID, time_sec, distance_cm_per_sec)
```
##Proportion of Behaviors

    To assign a behavior type we use regular expressions to identify the behavior from the predetermined object type as specified above in the behavioral classification section. After each sample point has been identified and placed in a bin of behavior types, specific behaviors can then be filtered out depending upon the target variables (i.e. only foraging behavior types).
    
    Once the desired subsample intervals are selected, the video has been calibrated and corrected for lens distortion, object and event types can then be created to classify subsamples and behavioral observations to be associated with recorded coordinate points (Neuswanger 2016b). The object types can be used to represent represent unique subsamples and will be exported into a vector named, "Object(s)" which will include the title of the object as well as the "index" which is used to represent an individual fish identification number. Additionally, the option to include a name with each object is given which will also be included in the "Object(s)" vector which should be used to identify species or specific individual fish if unique identification is possible. These object types should be saved as follows: Subsample_1, Subsample_2, Subsample_3, Subsample_4, Subsample_5, Subsample_6. 
    The event types will be represented by the behavioral classifications assigned to each 3 second sample increment in each subsample, this length of time allows for classification of unique behaviors as well as tracking movement accurately with small temporal increments (Rossi et al. 2019 in prep). The behavior classifications, as well as additional points to be recorded, and their definitions have been used or adopted from prior behavioral studies with some modifications (Kalleberg 1958; Nielsen 1992; Nakano et al. 1999a). They are as follows:
    
    Benthic Forage: A distinct forage event targeted at the stream benthos.
    Drift Forage: A fish maintaining positive rheotaxis to target prey carried through the water column in a sit-and-wait fashion. 
    Search Forage: A fish covering large foraging patches in search of non-benthic prey.
    Surface Strike: A fish making contact with the water surface to obtain prey.
    Aspirating: A fish visibly flaring their gills while minimally moving and making no forage attempts. 
    Attack: A fish making contact with another fish in an act of territoriality.
    Feint: Adopted from a fencing term, a fish will charge another in an act of territoriality, but make no contact and quickly resume foraging thereafter.
    Movement: Any movement throughout the pool not focused on foraging.
    Length: A fork length measurement taken by creating a point at the nose and the fork of the caudal fin and using the three-dimensional distance formula to calculate length.
    Surface Shots: Points taken on the surface (usually of an easily identifiable floating object) to record a Z-plane value for use in determining the distance fish are holding from the surface.
    
    The exemplary data is as follows:
```{r}
ForageBehaviors_Data <- VidSync_Test_Data %>% 
  filter(!grepl("Surface_Shots.*", objects)) %>%
  filter(!grepl("^Length.*", event)) %>%
  mutate(Behaviors = if_else(grepl("^Drift_Forage", event), "Drift Forage", 
                     if_else(grepl("^Search_Forage", event), "Search Forage", 
                     if_else(grepl("^Search_Forage", event), "Search Forage", 
                     if_else(grepl("^Benthic_Forage", event), "Benthic Forage", 
                     if_else(grepl("^Feint", event), "Feint", 
                     if_else(grepl("^Attack", event), "Attack",
                     if_else(grepl("^Surface_Strike", event), "Surface Strike", 
                     if_else(grepl("^Movement", event), "Movement", "NA"))))))))) %>% #Note that "nip" has since been changed to the definition of "attack" and attack to feint
  arrange(subsample, fish_ID, time_sec) %>% 
  select(subsample, fish_ID, time_sec, Behaviors)
```

##Distance from Surface

    
```{r, warning=FALSE}
DFS_Mean <- VidSync_Test_Data %>% 
  filter(grepl("Surface_Shots.*", objects)) %>% 
  summarise(mean(Z)) %>% 
  as.matrix()

DistFromSurface_Data <- VidSync_Test_Data %>%
  filter(!grepl("^Length.*", event), 
         !grepl("Surface_Shots.*", objects)) %>%
  select(subsample, fish_ID, time_sec, Z, event) %>% 
  group_by(fish_ID) %>%
  mutate(mean = mean(Z)) %>%
  mutate(DFS_cm = abs(mean - DFS_Mean)) %>% 
  distinct(fish_ID, .keep_all = TRUE) %>% 
  select(subsample, fish_ID, DFS_cm)
```
##Fork Length Calculations

    
```{R}
Length_Data <- VidSync_Test_Data %>% 
  filter(grepl("^Length.*", event)) %>% 
  na.omit() %>% 
  group_by(event) %>% 
  mutate(length_mm = 10*sqrt((X - lag(X, default = first(X)))^2 + 
                          (Y - lag(Y, default = first(Y)))^2) + 
                          (Z - lag(Z, default = first(Z)))^2) %>% 
  filter(!length_mm == 0) %>% 
  group_by(subsample, fish_ID) %>% 
  summarise(length_mm = mean(length_mm)) %>% 
  arrange(subsample, fish_ID)
```
##Occupied Volumes
This method makes use of delaunay triangulation to calculate the volumes of a three-dimensional point cloud using the Geometry package in R ()
```{r}
Volume_Data <- VidSync_Test_Data %>% 
  filter(!grepl("Surface_Shots.*", objects)) %>%
  filter(!grepl("^Length.*", event)) %>%
  select(subsample, fish_ID, X, Y, Z) %>%
  arrange(subsample, fish_ID)

Test_Volume <- Volume_Data %>% 
  filter(fish_ID == 1) %>% #Using a single volume output from a subsample as an example data point
  select(X, Y, Z) %>%
  as.matrix() %>%
  geometry::convhulln("FA") 
  print(Test_Volume$vol) #Displayed in cubic centimeters
  
#This can also be run in a for loop over the entire dataset from the sample to occupy a data frame with the collected volume data
Vol_forloop <- 
for (i in 1:33) {
  Volume_Data %>%
  filter(fish_ID == i) %>%
  select(X, Y, Z) %>%
  as.matrix() %>%
  geometry::convhulln("FA") 
}
```
#Discussion

challenges of using

    This study involved both Lagrangian and Eulerian sampling of organisms in the stream environment. The Lagrangian approach involves tracking an organism through time and space, while the Eulerian approach involves repeated sampling of animal distribution at fixed points in space and time (Smouse et el. 2010, Price 2006). In Elder Creek video of fish behavior was used to track individuals through time and space (Lagrangian) and to take scan samples of fish behavior over a fixed time interval (Eulerian). 



However, Lagrangian analysis in vidsync can also be done by moving the cameras to track fish (as Jason did in his Chinook feeding studies) rather than having the cameras in a fixed point. 

    Previously the habitat use of a foraging fish has been defined as a two dimensional area made from position estimations of fish from snorkel observations. 
    hypervolume definition
    recent hypervolume work -- Blonder et al 2013
    

#Acknowledgements


#Citations
Altmann, J. 1974. Observational study of behavior: sampling methods. Behaviour, 49(3-4): 227-266.

Clark, P. J., & Evans, F. C. 1954. Distance to nearest neighbor as a measure of spatial relationships in populations. Ecology, 35(4): 445-453.

Dill, L. M. 1983. Adaptive flexibility in the foraging behavior of fishes. Canadian Journal of Fisheries and Aquatic Sciences, 40(4): 398-408.

Fausch, K. D. 1984. Profitable stream positions for salmonids: relating specific growth rate to net energy gain. Canadian journal of zoology, 62(3): 441-451.

Fausch, K. D., Nakano, S., & Kitano, S. 1997. Experimentally induced foraging mode shift by sympatric charrs in a Japanese mountain stream. Behavioral Ecology, 8(4): 414-420.

Flore, L., Reckendorfer, W., & Keckeis, H. 2000. Reaction field, capture field, and search volume of 0+ nase (Chondrostoma nasus): effects of body size and water velocity. Canadian Journal of Fisheries and Aquatic Sciences, 57(2): 342-350.

Glass, T. 2013. Effects of water velocity and fish length on the shape and size of the foraging areas of juvenile salmonids.

Grant, J. W., Weir, L. K., & Steingrímsson, S. Ó. 2017. Territory size decreases minimally with increasing food abundance in stream salmonids: Implications for population regulation. Journal of Animal Ecology, 86(6): 1308-1316.

Hayes, J. W., Stark, J. D., & Shearer, K. A. 2000. Development and test of a whole-lifetime foraging and bioenergetics growth model for drift-feeding brown trout. Transactions of the American Fisheries Society, 129(2): 315-332.

Hughes, N. F., & Dill, L. M. 1990. Position choice by drift-feeding salmonids: model and test for Arctic grayling (Thymallus arcticus) in subarctic mountain streams, interior Alaska. Canadian Journal of Fisheries and Aquatic Sciences, 47(10): 2039-2048.

Hughes, N. F., & Kelly, L. H. 1996. New techniques for 3-D video tracking of fish swimming movements in still or flowing water. Canadian Journal of Fisheries and Aquatic Sciences, 53(11): 2473-2483.

Hooge, P. N., & Eichenlaub, B. 2000. Animal movement extension to ArcView 2.0. USGS Alaska Science Center, Anchorage, AK.

Kalleberg, H. 1958. Observations in a stream tank of territoriality and competition in juvenile salmon and trout. Rep. Inst. Freshw. Res. Drottninigholm, 39: 55-98.

Nakano, S., Fausch, K. D., & Kitano, S. 1999a. Flexible niche partitioning via a foraging mode shift: a proposed mechanism for coexistence in stream‐dwelling charrs. Journal of Animal Ecology, 68(6): 1079-1092.

Nakano, S., Kawaguchi, Y., Taniguchi, Y., Miyasaka, H., Shibata, Y., Urabe, H., & Kuhara, N. 1999b. Selective foraging on terrestrial invertebrates by rainbow trout in a forested headwater stream in northern Japan. Ecological Research, 14(4): 351-360.

Neuswanger, J., Wipfli, M. S., Rosenberger, A. E., & Hughes, N. F. 2014. Mechanisms of drift-feeding behavior in juvenile Chinook salmon and the role of inedible debris in a clear-water Alaskan stream. Environmental biology of fishes, 97(5): 489-503.

Neuswanger, Jason R., Wipfli, Mark S., Rosenberger, Amanda E., and Hughes, 
Nicholas F. 2016a. Measuring fish and their physical habitats: Versatile 2-D and 3-D video techniques with user-friendly software. Canadian Journal of Fisheries and Aquatic Sciences 73(12): 1861-1873.

Neuswanger, Jason R. Drift Model Project. 2016b. VidSync 3-D Video Analysis Tutorial. Retrieved from https://www.youtube.com/watch?v=tJKVgfPcC-A&t=5273s

Nielsen, J. L. 1992. Microhabitat-specific foraging behavior, diet, and growth of juvenile coho salmon. Transactions of the American Fisheries Society, 121(5): 617-634.

Nielsen, J. L., Lisle, T. E., & Ozaki, V. 1994. Thermally stratified pools and their use by steelhead in northern California streams. Transactions of the American Fisheries Society, 123(4): 613-626.

Nislow, K. H., Folt, C., & Seandel, M. 1998. Food and foraging behavior in relation to microhabitat use and survival of age-0 Atlantic salmon. Canadian Journal of Fisheries and Aquatic Sciences, 55(1): 116-127.

Piccolo, J. J., Hughes, N. F., & Bryant, M. D. 2007. The effects of water depth on prey detection and capture by juvenile coho salmon and steelhead. Ecology of freshwater fish, 16(3): 432-441.

Rossi, Gabriel J., Power, Mary E., Pneh, Shelly, Neuswanger, Jason R. 2019 in preparation. Seasonal Foraging Mode Shifts of Oncorhynchus mykiss in a Mediterranean Stream.

RStudio Team. 2015. RStudio: Integrated Development for R. RStudio, Inc., Boston, MA URL http://www.rstudio.com/.

Sánchez-Hernández, J., Servia, M. J., Vieira-Lanero, R., & Cobo, F. 2012. Ontogenetic dietary shifts in a predatory freshwater fish species: the brown trout as an example of a dynamic fish species. In New advances and contributions to fish biology. IntechOpen.

Sih, A., Ferrari, M. C., & Harris, D. J.2011. Evolution and behavioural responses to human‐induced rapid environmental change. Evolutionary applications, 4(2): 367-387.

Steingrímsson, S. Ó., & Grant, J. W. 2008. Multiple central‐place territories in wild young‐of‐the‐year Atlantic salmon Salmo salar. Journal of Animal Ecology, 77(3): 448-457.

Steingrimsson, S.Ó., and Grant, J.W.A. 2011. Shape of single and multiple central-place territories in a stream-dwelling fish. Ethology 117: 1170-1177.

Tunney, T. D., & Steingrímsson, S. Ó. 2012. Foraging mode variation in three stream‐dwelling salmonid fishes. Ecology of Freshwater Fish, 21(4): 570-580.

Vivancos, A., & Closs, G. P. 2015. Quantification and comparison of individual space-use strategies in foraging drift-feeding fish using fine-scale, multidimensional movement analysis. Canadian journal of fisheries and aquatic sciences, 72(11): 1760-1768.

Walton, Izaak. 1655. The Compleat Angler, or, The Contemplative Man's Recreation : Being a Discourse of Rivers, and Fish-Ponds, and Fish, and Fishing, Not Unworthy the Perusal of Most Anglers. London: Printed by T. M. [ie. T. Maxey] for Rich. Marriot, and are to be sold at his shop. Print.

Wickham, Hadley. 2018. stringr: Simple, Consistent Wrappers for
Common String Operations. R package version 1.3.1.
https://CRAN.R-project.org/package=stringr